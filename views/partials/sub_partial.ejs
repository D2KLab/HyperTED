<div class="container-fluid">

    <div class="row">
        <div class="col-md-12 col-lg-12 col-sm-12 col-xs-12">
            <%
            if (metadata && metadata.timedtext) {
                var strList = metadata.timedtext.split('\n\n'), subList = [];
                if (strList.length < 2) {
                    strList = metadata.timedtext.substr(1).split('\n\r');
                }
                var charIndex = -1;
            %>
            <div class="sub-text <% if (locals.enriched) { %>enriched<% } %>">
                <%
                    for (var index in strList) {
                        var sub = {text: '', lineNum: 0};
                        var lines = strList[index].split('\n');

                        for (var line in lines) {
                            if (!sub.id) {
                                sub.id = lines[line];
                            } else if (!sub.time) {
                                sub.time = lines[line].replace('\r', '');
                            } else {
                                var start = sub.lineNum > 0 ? '\n' : '';
                                sub.text += start + lines[line];
                                sub.lineNum++;
                            }
                        }

//                        var subStart = strList[index].substring(4, 16);
//                        var subEnd = strList[index].substring(21, 33);
//
////                        console.log(subStart);
////                        console.log(subEnd);
//                        console.log("*****");


                        sub.startChar = charIndex + 1;
                        charIndex = sub.startChar + sub.text.length; //because of a '\n' is a fake double char
                        sub.endChar = charIndex;
                        subList.push(sub);
                    }



                    if (locals.enriched && locals.entities) {
                        var entityList = entities;
                        var subIndex = subList.length - 1;

                        function calcTime(subTime) {
                            return (subTime < 60) ? "00:00:" + Math.floor(subTime) : (subTime == 60 || subTime > 60 && subTime < 3600) ? "00:" + Math.floor(subTime / 60) + ":" + Math.floor(subTime % 60) : Math.floor(subTime / 3600) + ":" + Math.floor((subTime % 3600) / 60) + ":" + Math.floor((subTime % 3600) % 60);
                        }

                        //sorting JSON for end character desc and by length
                        entityList.sort(function SortByStartChar(x, y) {
                            if (x.endChar == y.endChar) {
                                return ((x.label.length == y.label.length) ? 0 : (x.label.length < y.label.length) ? 1 : -1)
                            } else if (x.endChar > y.endChar) return -1;
                            else return 1;
                        });


                        entityList.forEach(function (entity) {
                            while (subIndex >= 0) {

                                var thisSub = subList[subIndex];
                                if (thisSub.lineNum != 0) {
                                    var subStart = thisSub.time.substring(0, 12);
                                    var subEnd = thisSub.time.substring(18, 30);
                                }

                                var entStart = calcTime(entity.startNPT);
                                var entEnd = calcTime(entity.endNPT);


                                if (entStart >= subStart && entEnd <= subEnd) {


                                    var text = thisSub.text;
                                    var href = entity.uri ? 'href="' + entity.uri + '" target="_blank"' : '';
                                    var nerdType = entity.nerdType.split('#')[1].toLowerCase();

//                        var str = '<span class="entity ' + nerdType + '"><a ' + href + ' data-start-time="' + entity.startNPT + '" data-end-time="' + entity.endNPT + '">' + entity.label + '</a></span>';
                                    var str = '<span class="entity ' + nerdType + '">' + entity.label + '</span>';
                                    thisSub.text = text.replace(entity.label, str);


                                    break;
                                } else {
                                    subIndex--;
                                }
                                }

                        });
                    }

                        subList.forEach(function(sub){
                %>
                <p data-id="<%= sub.id %>" data-time="<%= sub.time %>"><%- sub.text %></p>
                <% }); %>
            </div>
            <% } %>
        </div>
    </div>
</div>