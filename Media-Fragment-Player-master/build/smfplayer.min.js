/*!
 * Synote Media Fragment Player
 *
 * Playing Media Fragment URIs using mediaelementjs player
 *  
 * Copyright 2013 Yunjia Li, University of Southampton (http://www.ecs.soton.ac.uk/people/yl2)
 * Licensed under the MIT License.
 *
 */var MediaFragments=function(d){if(!Array.prototype.forEach)Array.prototype.forEach=function(e,b){if(this===void 0||this===null)throw new TypeError;var a=Object(this),c=a.length>>>0;if(typeof e!=="function")throw new TypeError;for(var i=0;i<c;i++)i in a&&e.call(b,a[i],i,a)};var m=function(e){console.log("Media Fragments URI Parsing Warning: "+e)},s={t:function(e){var b=e.split(",");if(b.length>2)return false;var a=b[0]?b[0]:"";b=b[1]?b[1]:"";if(a===""&&b===""||a&&!b&&e.indexOf(",")!==-1)return false;
var c=/^((npt\:)?((\d+\:(\d\d)\:(\d\d))|((\d\d)\:(\d\d))|(\d+))(\.\d*)?)?$/;if(c.test(a)&&c.test(b)){a=a.replace(/^npt\:/,"");a=a.replace(/\.$/,"");b=b.replace(/\.$/,"");c=function(f){if(f==="")return false;var j,g;f=f.split(":");j=f.length;if(j===3){j=parseInt(f[0],10);g=parseInt(f[1],10);f=parseFloat(f[2])}else if(j===2){j=0;g=parseInt(f[0],10);f=parseFloat(f[1])}else if(j===1){g=j=0;f=parseFloat(f[0])}else return false;if(j>23){m("Please ensure that hours <= 23.");return false}if(g>59){m("Please ensure that minutes <= 59.");
return false}if(f>=60){m("Please ensure that seconds < 60.");return false}return j*3600+g*60+f};var i=c(a),n=c(b);if(a&&b)if(i<n)return{value:e,unit:"npt",start:a,end:b,startNormalized:i,endNormalized:n};else{m("Please ensure that start < end.");return false}else if(c(a)!==false||c(b)!==false)return{value:e,unit:"npt",start:a,end:b,startNormalized:i===false?"":i,endNormalized:n===false?"":n};else{m("Please ensure that start or end are legal.");return false}}c=/^(\d+\:\d\d\:\d\d(\:\d\d(\.\d\d)?)?)?$/;
i=a.replace(/^(smpte(-25|-30|-30-drop)?).*/,"$1");a=a.replace(/^smpte(-25|-30|-30-drop)?\:/,"");if(c.test(a)&&c.test(b)){c=function(f){if(f==="")return false;var j,g,l,o;f=f.split(":");j=f.length;if(j===3){j=parseInt(f[0],10);g=parseInt(f[1],10);l=parseInt(f[2],10);o=f=0}else if(j===4){j=parseInt(f[0],10);g=parseInt(f[1],10);l=parseInt(f[2],10);if(f[3].indexOf(".")===-1){f=parseInt(f[3],10);o=0}else{o=f[3].split(".");f=parseInt(o[0],10);o=parseInt(o[1],10)}}else return false;if(j>23){m("Please ensure that hours <= 23.");
return false}if(g>59){m("Please ensure that minutes <= 59.");return false}if(l>59){m("Please ensure that seconds <= 59.");return false}return j*3600+g*60+l+f*0.0010+o*1.0E-6};if(a&&b)if(c(a)<c(b))return{value:e,unit:i,start:a,end:b};else{m("Please ensure that start < end.");return false}else if(c(a)!==false||c(b)!==false)return{value:e,unit:i,start:a,end:b};else{m("Please ensure that start or end are legal.");return false}}c=/^((\d{4})(-(\d{2})(-(\d{2})(T(\d{2})\:(\d{2})(\:(\d{2})(\.(\d+))?)?(Z|(([-\+])(\d{2})\:(\d{2})))?)?)?)?)?$/;
a=a.replace("clock:","");if(c.test(a)&&c.test(b))if(a&&b&&!isNaN(Date.parse("2009-07-26T11:19:01Z")))if(Date.parse(a)<=Date.parse(b))return{value:e,unit:"clock",start:a,end:b};else{m("Please ensure that start < end.");return false}else return{value:e,unit:"clock",start:a,end:b};m("Invalid time dimension.");return false},xywh:function(e){var b=/^percent\:\d+,\d+,\d+,\d+$/,a=e.replace(/(pixel|percent)\:/,"").split(","),c=a[0],i=a[1],n=a[2];a=a[3];if(/^(pixel\:)?\d+,\d+,\d+,\d+$/.test(e))if(n>0&&a>0)return{value:e,
unit:"pixel",x:c,y:i,w:n,h:a};else{m("Please ensure that w > 0 and h > 0");return false}else{if(b.test(e)){if(function(f,j,g,l){if(!(0<=f&&f<=100)){m("Please ensure that 0 <= x <= 100.");return false}if(!(0<=j&&j<=100)){m("Please ensure that 0 <= y <= 100.");return false}if(!(0<=g&&g<=100)){m("Please ensure that 0 <= w <= 100.");return false}if(!(0<=l&&l<=100)){m("Please ensure that 0 <= h <= 100.");return false}return true}(c,i,n,a))return{value:e,unit:"percent",x:c,y:i,w:n,h:a};m("Invalid percent selection.")}else m("Invalid spatial dimension.");
return false}},track:function(e){return{value:e,name:e}},id:function(e){return{value:e,name:e}},chapter:function(e){return{value:e,chapter:e}}},r=function(e){var b={};e.split("&").forEach(function(a){var c=a.indexOf("=");if(!(c<1)){var i=[a.substring(0,c),a.substring(c+1)];if(i[1]){a=decodeURIComponent(i[0]);c=s[a];i=decodeURIComponent(i[1]);if(c)if(i=c(i)){b[a]||(b[a]=[]);if(a!=="t")b[a].push(i);else b[a][0]=i}}}});return b};return{parse:function(e){return MediaFragments.parseMediaFragmentsUri(e)},
parseMediaFragmentsUri:function(e){e=e?e:d.location.href;var b=e.indexOf("#"),a=e.indexOf("?"),c=b!==-1?b:e.length;a=a!==-1?e.substring(a+1,c):"";e=b!==-1?e.substring(b+1):"";var i=r(a),n=r(e);return{query:i,hash:n,toString:function(){var f=function(j,g){var l="\n["+j+"]:\n";if(!Object.keys)Object.keys=function(o){if(o!==Object(o))throw new TypeError("Object.keys called on non-object");var p=[],k;for(k in o)Object.prototype.hasOwnProperty.call(o,k)&&p.push(k);return p};Object.keys(g).forEach(function(o){l+=
"  * "+o+":\n";g[o].forEach(function(p){l+="    [\n";Object.keys(p).forEach(function(k){l+="      - "+k+": "+p[k]+"\n"});l+="   ]\n"})});return l};return f("Query",i)+f("Hash",n)}}}}}(window),smfplayer=smfplayer||{};smfplayer.version="v0.2";
smfplayer.utils={durationMax:4294967295,audioList:["wma","m4a","mp3","wav","mpeg"],videoList:["mp4","m4v","mov","wmv","flv","ogg","webm"],isYouTubeURL:function(d,m){return d.match(/^https?:\/\/(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/)?m!==true?RegExp.$1:true:false},isDailyMotionURL:function(d){return d.match(/^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/)!==null?true:false},isVimeoURL:function(d){return d.match(/^.+vimeo.com\/(\d+)?/)!==null?true:false},isValidURL:function(d){return/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?(#([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)?$/.test(d)?
true:false},isiPad:function(){return navigator.userAgent.match(/iPad/i)==null?false:true},getTemporalMF:function(d){var m=d.start?d.startNormalized:0;d=d.end?d.endNormalized:this.durationMax;m=parseFloat(m);d=parseFloat(d);return{st:m,et:d}},getSpatialMF:function(){}};
(function(d,m){function s(f,j){var g=decodeURI(f);g=c[j?"strict":"loose"].exec(g);for(var l={attr:{},param:{},seg:{}},o=14;o--;)l.attr[b[o]]=g[o]||"";l.param.query={};l.param.fragment={};l.attr.query.replace(i,function(p,k,q){if(k)l.param.query[k]=q});l.attr.fragment.replace(n,function(p,k,q){if(k)l.param.fragment[k]=q});l.seg.path=l.attr.path.replace(/^\/+|\/+$/g,"").split("/");l.seg.fragment=l.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");l.attr.base=l.attr.host?l.attr.protocol+"://"+l.attr.host+
(l.attr.port?":"+l.attr.port:""):"";return l}function r(f){f=f.tagName;if(f!==m)return e[f.toLowerCase()];return f}var e={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},b=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],a={anchor:"fragment"},c={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},i=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,n=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;d.fn.url=function(f){var j="";if(this.length)j=d(this).attr(r(this[0]))||"";return d.url(j,f)};d.url=function(f,j){if(arguments.length===1&&f===true){j=true;f=m}j=j||false;f=f||window.location.toString();return{data:s(f,j),attr:function(g){g=
a[g]||g;return g!==m?this.data.attr[g]:this.data.attr},param:function(g){return g!==m?this.data.param.query[g]:this.data.param.query},fparam:function(g){return g!==m?this.data.param.fragment[g]:this.data.param.fragment},segment:function(g){if(g===m)return this.data.seg.path;else{g=g<0?this.data.seg.path.length+g:g-1;return this.data.seg.path[g]}},fsegment:function(g){if(g===m)return this.data.seg.fragment;else{g=g<0?this.data.seg.fragment.length+g:g-1;return this.data.seg.fragment[g]}}}}})(jQuery);
(function(d){var m={width:640,height:480,originalWidth:320,originalHeight:240,isVideo:true,mfAlwaysEnabled:false,spatialEnabled:true,spatialStyle:{},autoStart:true,tracks:[]},s={init:function(e){var b=this;this.pause=function(){d(this).data("smfplayer").smfplayer!==undefined?d(this).data("smfplayer").smfplayer.pause():console.error("smfplayer hasn't been initalised")};this.play=function(){var a=d(this).data("smfplayer").smfplayer;a!==undefined?a.play():console.error("smfplayer hasn't been initalised")};
this.playmf=function(){var a=d(this).data("smfplayer");if(a===undefined)setTimeout(function(){b.playmf()},100);else{var c=0;if(!d.isEmptyObject(a.mfjson.hash))c=smfplayer.utils.getTemporalMF(a.mfjson.hash.t[0]).st;var i=d(this).data("smfplayer").smfplayer;this.setPosition(c*1E3);i.media.paused&&i.play();a.mfreplay=true}};this.showxywh=function(a){var c=d(this).data("smfplayer");if(c===undefined)setTimeout(function(){b.showxywh(a)},100);else if(!(d.isEmptyObject(a)||c.settings.spatialEnabled!==true)){var i;
if(c.settings.xywhoverlay===undefined){this.addClass("smfplayer-container");i=d("<div/>");i.css(c.settings.spatialStyle);i.addClass("smfplayer-overlay").appendTo(this);c.settings.xywhoverlay=i}else i=c.settings.xywhoverlay;var n=a.unit;x=a.x;y=a.y;w=a.w;h=a.h;if(n==="percent"){x=Math.floor(x/100*c.settings.width);w=Math.floor(w/100*c.settings.width);y=Math.floor(y/100*c.settings.height);h=Math.floor(h/100*c.settings.height)}i.css({width:w,height:h,top:y+"px",left:x+"px"});i.show()}};this.hidexywh=
function(){var a=d(this).data("smfplayer");if(a===undefined)setTimeout(function(){b.hidexywh()},100);else a.settings.xywhoverlay!==undefined&&a.settings.xywhoverlay.hide()};this.load=function(){var a=d(this).data("smfplayer").smfplayer;a!==undefined?a.load():console.error("smfplayer hasn't been initalised")};this.getPosition=function(){var a=d(this).data("smfplayer").smfplayer;if(a)return parseInt(a.getCurrentTime()*1E3);else{console.error("smfplayer hasn't been initalised");return-1}};this.setPosition=
function(a){var c=d(this).data("smfplayer").smfplayer;a=a?a:0;if(c!==undefined)b.getPosition()<=0?setTimeout(function(){b.setPosition(a)},100):c.setCurrentTime(a/1E3);else console.error("smfplayer hasn't been initalised")};this.getDuration=function(){var a=d(this).data("smfplayer").smfplayer;if(a!==undefined)return a.duration*1E3;else{console.error("smfplayer hasn't been initalised");return-1}};this.getMFJson=function(){return d(this).data("smfplayer").mfjson};this.getMeplayer=function(){return d(this).data("smfplayer").smfplayer};
this.getOptions=function(){return d(this).data("smfplayer").settings};this.getDomObject=function(){return d(this).data("smfplayer").smfplayer.domNode};return this.each(function(){var a=d(this);if(a.data("smfplayer")===undefined){var c=d.extend({},m,e);if(c.mfURI===undefined){console.error("mfURI cannot be null!");return false}var i=MediaFragments.parseMediaFragmentsUri(c.mfURI);c.success=function(g,l){if(c.autoStart===true)if(g.pluginType=="flash")g.addEventListener("canplay",function(){g.play();
if(d(b).data("smfplayer")===undefined)setTimeout(function(){var k=r(d(b).data("smfplayer").mfjson);b.setPosition(k.st*1E3);!d.isEmptyObject(k.xywh)&&d(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(k.xywh)},100);else{var p=r(d(b).data("smfplayer").mfjson);b.setPosition(p.st*1E3);!d.isEmptyObject(p.xywh)&&d(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(p.xywh)}},false);else{g.play();if(d(b).data("smfplayer")===undefined)setTimeout(function(){var p=r(d(b).data("smfplayer").mfjson);
b.setPosition(p.st*1E3);!d.isEmptyObject(p.xywh)&&d(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(p.xywh)},100);else{var o=r(d(b).data("smfplayer").mfjson);b.setPosition(o.st*1E3);!d.isEmptyObject(o.xywh)&&d(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(o.xywh)}}g.addEventListener("timeupdate",function(){var p=g.currentTime,k=d(b).data("smfplayer");if(k!==undefined){var q=r(k.mfjson),t=q.st,u=q.et;q=q.xywh;if(p<u&&p>t){if(k!==undefined)if(!d.isEmptyObject(q)&&k.settings.spatialEnabled===
true)if(k.settings.xywhoverlay===undefined||!k.settings.xywhoverlay.is(":visible"))b.showxywh(q);if(k.setPositionLock===true)k.setPositionLock=false}else{k.settings.xywhoverlay!==undefined&&k.settings.xywhoverlay.is(":visible")&&b.hidexywh();if(k.mfreplay===true||c.mfAlwaysEnabled===true)if(p>u){g.pause();b.setPosition(u*1E3);k.mfreplay=false}else if(p<t)if(k.setPositionLock===false){b.setPosition(t*1E3);k.setPositionLock=true}}}},false);g.addEventListener("play",function(){var p=g.currentTime,k=
d(b).data("smfplayer");if(k!==undefined){var q=r(k.mfjson),t=q.st;q=q.et;if(k.mfreplay===true)if(p<t){if(k.setPositionLock===false){b.setPosition(t*1E3);k.setPositionLock=true}}else if(p>q)if(k.setPositionLock===false){b.setPosition(q*1E3);k.setPositionLock=true;g.pause();k.mfreplay=false}}},false);if(e.success!==undefined)return e.success.call(this,g,l)};c.error=function(){if(e.error!==undefined)return e.error.call(this)};var n=c.mfURI;if(!d.isEmptyObject(i.hash)){n=c.mfURI.indexOf("#");n=n!==-1?
c.mfURI.substring(0,n):c.mfURI}var f;f=c.isVideo===false?d("<audio/>").prop("width",c.width).prop("height",c.height).prop("preload","auto").appendTo(a):d("<video/>").prop("width",c.width).prop("height",c.height).prop("preload","auto").appendTo(a);n=d("<source/>").prop("src",n).appendTo(f);if(smfplayer.utils.isYouTubeURL(c.mfURI))n.prop("type","video/x-youtube");else if(smfplayer.utils.isDailyMotionURL(c.mfURI))n.prop("type","video/dailymotion");else if(smfplayer.utils.isVimeoURL(c.mfURI))n.prop("type",
"video/vimeo");else{var j=d.url(c.mfURI).attr("file").toLowerCase().split(".");if(j.length>1)if(j=j[j.length-1].toLowerCase())if(d.inArray(j,smfplayer.utils.videoList)!=-1)n.attr("type","video/"+j);else d.inArray(j,smfplayer.utils.audioList)!=-1&&n.prop("type","audio/"+j)}d.each(c.tracks,function(g,l){d("<track/>").appendTo(f).prop("srclang",l.srclang).prop("kind",l.kind).prop("type",l.type).prop("src",l.src)});n=new MediaElementPlayer(f.get(0),c);a.data("smfplayer",{target:a,smfplayer:n,settings:c,
mfjson:i,mfreplay:true,setPositionLock:false})}})},destroy:function(){return this.each(function(){var e=d(this);e.data("smfplayer");d(window).unbind(".smfplayer");e.removeData("smfplayer");e.empty()})}},r=function(e){var b=0,a=smfplayer.utils.durationMax;if(!d.isEmptyObject(e.hash.t)){a=smfplayer.utils.getTemporalMF(e.hash.t[0]);b=a.st;a=a.et}var c={};d.isEmptyObject(e.hash.xywh)||(c=e.hash.xywh[0]);return{st:b,et:a,xywh:c}};d.fn.smfplayer=function(e){if(s[e])return s[e].apply(this,Array.prototype.slice.call(arguments,
1));else if(typeof e==="object"||!e)return s.init.apply(this,arguments);else d.error("Method "+e+" does not exist on jQuery.smfplayer")}})(jQuery);
